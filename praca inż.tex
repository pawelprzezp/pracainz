%PrzykĹ‚adowy plik uĹ‚atwiajÄ…cy zĹ‚oĹĽenie projektu dyplomowego inĹĽynierskiego.
%UWAGA: Generowany napis na stronie tytuĹ‚owej o treĹ›ci PROJEKT DYPLOMOWY INĹ»YNIERSKI zostaĹ‚ zaproponowany przeze mnie i nie jest, pĂłki co, potwierdzony przez wĹ‚adze wydziaĹ‚u. Przed ostatecznym oddaniem tak zĹ‚oĹĽonej pracy naleĹĽy upewniÄ‡ siÄ™ jaka powinna byÄ‡ treĹ›Ä‡ tego napisu. W momencie gdy uzyskam informacjÄ™ na temat treĹ›ci tego napisu, dokonam niezbÄ™dnych zmian w ĹşrĂłdĹ‚ach.

\documentclass[eng,printmode]{mgr}
%opcje klasy dokumentu mgr.cls zostaĹ‚y opisane w doĹ‚Ä…czonej instrukcji

%poniĹĽej deklaracje uĹĽycia pakietĂłw, usunÄ…Ä‡ to co jest niepotrzebne
\usepackage{polski} %przydatne podczas skĹ‚adania dokumentĂłw w j. polskim
%\usepackage[polish]{babel}%alternatywnie do pakietu polski, wybraÄ‡ jeden z nich
\usepackage[utf8]{inputenc} %kodowanie znakĂłw, zaleĹĽne od systemu
\usepackage[T1]{fontenc} %poprawne skĹ‚adanie polskich czcionek

%pakiety do grafiki
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage{psfrag}
\usepackage[polish]{babel}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}
\selectlanguage{polish}
%pakiety dodajÄ…ce duĹĽo dodatkowych poleceĹ„ matematycznych
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{upgreek}

%pakiety wspomagajÄ…ce i poprawiajÄ…ce skĹ‚adanie tabel
\usepackage{supertabular}
\usepackage{array}
\usepackage{tabularx}
\usepackage{hhline}

%pakiet wypisujÄ…cy na marginesie etykiety rĂłwnaĹ„ i rysunkĂłw zdefiniowanych przez \label{}, chcÄ…c wygenerowaÄ‡ finalnÄ… wersjÄ™ dokumentu wystarczy usunÄ…Ä‡ poniĹĽszÄ… liniÄ™
\usepackage{showlabels}

%definicje wĹ‚asnych poleceĹ„
\newcommand{\R}{I\!\!R} %symbol liczb rzeczywistych, dziaĹ‚a tylko w trybie matematycznym
\newtheorem{theorem}{Twierdzenie}[section] %nowe otoczenie do skĹ‚adania twierdzeĹ„

%dane do zĹ‚oĹĽenia strony tytuĹ‚owej
\title{Wyznaczanie kierunku przylotu sygnału akustycznego z zastosowaniem systemu mikrofonów}
\engtitle{Determination of the direction of acoustic signal arrival using a microphone system}
\author{Paweł Rachwalski}
\supervisor{dr inż. Bogdan Kreczmer. PWr, I-6}
%\guardian{dr hab. inĹĽ. ImiÄ™ Nazwisko Prof. PWr, I-6} %nie uĹĽywaÄ‡ jeĹ›li opiekun jest tÄ… samÄ… osobÄ… co prowadzÄ…cy pracÄ™

%\date{2008} %standardowo u doĹ‚u strony tytuĹ‚owej umieszczany jest bieĹĽÄ…cy rok, to polecenie pozwala wstawiÄ‡ dowolny rok

%poniĹĽej jest lista kierunkĂłw i specjalnoĹ›ci na wydziale elektroniki, naleĹĽy wybraÄ‡ wĹ‚aĹ›ciwe lub dopisaÄ‡ jeĹ›li nie ma odpowiednich
\field{Automatyka i Robotyka (AIR)}
\specialisation{Robotyka (ARR)}
%\specialisation{Komputerowe sieci sterowania (ARK)}
%\specialisation{Systemy informatyczne w automatyce (ASI)}
%\specialisation{Komputerowe systemy zarzÄ…dzania \\procesami produkcyjnymi (ARS)}
%\field{Elektronika i telekomunikacja (EIT)}
%\specialisation{Akustyka (ETA)}
%\specialisation{Aparatura elektroniczna (EAE)}
%\specialisation{Elektroniczne i komputerowe \\systemy automatyki (ESA)}
%\specialisation{Zastosowania inĹĽynierii komputerowej \\w technice (EZI)}
%\specialisation{InĹĽynieria dĹşwiÄ™ku (EID)}
%\specialisation{Elektronika stosowana \\i optokomunikacja (TEO)}
%\specialisation{Telekomunikacyjne sieci szerokopasmowe (TSS)}
%\specialisation{Teleinformatyczne sieci mobilne (TSM)}
%\specialisation{SygnaĹ‚y w telekomunikacji cyfrowej (TSC)}
%\specialisation{Teleinformatyczne systemy rozsiewcze (TSR)}
%\field{Informatyka (INF)}
%\specialisation{Systemy informatyki w medycynie \\i technice (IMT)}
%\specialisation{InĹĽynieria systemĂłw informatycznych (INS)}
%\specialisation{InĹĽynieria internetowa (INT)}
%\specialisation{Systemy i sieci komputerowe (ISK)}
%\field{Teleinformatyka (TIN)}
%\specialisation{Teleinformatyka (TIN)}

%tutaj zaczyna siÄ™ wĹ‚aĹ›ciwa treĹ›Ä‡ dokumentu
\begin{document}
\bibliographystyle{plabbrv} %tylko gdy uĹĽywamy BibTeXa, ustawia polski styl bibliografii

\maketitle %polecenie generujÄ…ce stronÄ™ tytuĹ‚owÄ…
\dedication{6cm}{Pracę tę dedykuję rodzicom, w podziękowaniu za wsparcie i wiarę w moje możliwości}

\tableofcontents %spis treĹ›ci

%poniĹĽej znajduje siÄ™ przykĹ‚adowa treĹ›Ä‡ dalszej czÄ™Ĺ›ci dokumentu, zainteresowanych zachÄ™cam do rozszyfrowania frazy "Lorem ipsum" :)
\chapter{Wstęp}
Wstępwstepepepepepepepepeppeepep

\chapter{Analiza problemu}
Źródłem dźwięku jest ciało wytrwarzające mechaniczną falę poprzeczną, fala ta może rozchodzić się tylko w ośrodkach sprężystych takich jak ciała stałe, ciecze i gazy. Mikrofon tak samo jak ludzkie ucho jest wrażliwy na ciśnienie akustyczne,  czyli zmienne w czasie odchylenie wartości ciśnienia statycznego panującego w ośrodku wywołane rozchodzeniem w nim fali akustycznej". %wikipedia
Źródła dźwięku można lokalizować i analizować za pomocą układów mikrofonowych oraz różnych metod. Poprawne rozwiąznie problemu zlokalizowania dźwięku polega na dobraniu odpowiedniego algorytmu lokalizacji oraz na poprawnym skonstruowaniu matrycy mikrofonów. 
 \newline




\section{TDOA}
Metoda Time Delay of Arrival(TDOA)jest często wykorzystywana w systemach lokalizacji źródła dźwięku ze względu na prostotę jej implementacji. Polega na zbieraniu próbek dźwięku i ich analizie, która odbywa się głównie w dwóch etapach. Pierwszym etapem jest identyfikacja opóźnienia czasowego próbek na różnych mikrofonach, opóźnienie to oznacza się symbolem $\tau$. Kolejny etap to obliczenie położenia źródła dźwięku na podstawie geometrii matrycy mikrofonów.
\begin{figure}[ht]

    \centering

  \includegraphics[width=0.5\textwidth, angle=0]{matryca.png}

    \caption{Liniowa matryca mikrofonów}

    

\end{figure}
\newpage Posiadając dane takie jak  opóźnienie synału oraz odległość miedzy mikrofonami, można wyznaczyć kąt $\theta$ za pomocą wzoru,
\begin{equation}
\theta = arcsin(\frac{\tau*V_{a}}{d}) 
\end{equation}
gdzie $\tau$ to opóźnienie sygnału, $V_{a}$ to prędkość sygnału w danym ośrodku, $d$ to odległość miedzy mikrofonami.

\section{Beamforming --- opóźnienie i sumowanie}
Metoda {\em beamforming} pierwotnie została stworzona na potrzeby kształtowania wiązki sygnału emitowanej przez nadajniki. Zauważono że może być ona wykorzystywana w przypadku odbiorników do przetwarzania danych pozyskancyh z matrycy czujników w celu wyznaczenia obrazu kierunkowego natężenia sygnału . Technika ta jest stosowana zarówno do ciągłego jak i dyskretnego rozkładu sygnału. Pozwala ona na budowe różnego typu matryc, w zależności od dostępnego sprzętu, pożądanej rozdzielczości przestrzennej oraz wrażliwości na wybrany kierunek. W porównaniu do metody TDOA {\em beamforming} wymaga wiele większej wydajności obliczeniowej. Konieczne też jest odpowiednie umieszcznie mikrofonów na matrycy, by uniknąć aliasingu przestrzennego.
\newline Tego niekorzystnego zjawiska można uniknąć jeśli różnica faz miedzy dwoma próbkowanymi sygnałami będzie mieściła się w przedziale wartości (-$\pi$,$\pi$), warunek ten jest spełniony gdy odległość miedzy czujnikami odpowiada nierówności:
\begin{equation}
 d <(\frac{s}{f_{max}}) 
\end{equation}

Najprostsze podejście związane z formowaniem wiązki sygnału opiera się na algorytmie DAS (Delay and Sum). W podejściu tym sygnały otrzymane z każdego z mikrofonów jest podawany na wejście osobnego bloku, który wprowadza odpowiednie opóźnienie. Otrzymane w ten sposób sygnały z wyjść wspomnianych bloków są sumowane. Układ taki określany jest mianem {\em beamformer} (patrz rys. \ref{fig-beamformer}).
\begin{figure}[ht]

    \centering

  \includegraphics[width=0.5\textwidth, angle=0]{DAS.png}

    \caption{Schemat blokowy reprezentujący metodę DAS}
 \label{fig-beamformer}
    

\end{figure}
\newline 
Kierunek wyjścia wiązki $y_{\Phi}[k]$ jest określony w dziedzinie czasu przez zestaw wag $h_{i}$:
\begin{equation}
 y_{\Phi}[k] = \sum_{i=1}^n x_{i}[k-h_{i}(\phi)] 
\end{equation}
Gdzie $x_{i}[n]$ jest sygnałem odebranym przez mikrofon a $h_{i}(\Phi)$ jest opóźnieniem dla charakterystyki kierunkowej kąta.
Wartość RMS dla charakterystyk kierunkowych kąta oblicza się ze wzoru:
\begin{equation}
 V_{RMS}[\phi] = \sqrt{\frac{1}{N}\sum_{i=1}^N y_{\Phi}[i]^2 }
\end{equation}
Maksymalna wartość wyjścia RMS beamformera determinuje kąt pod którym znajduję się źródło dźwięku:
\begin{equation}
 \alpha = argmax(V_{RMS}[\phi])
\end{equation}
 Upraszczając przebieg algorytmu wygląda w sposób następujący:
 \begin{itemize}
\item Rejestracja sygnału.
\item Sumowanie opóźnień odpowiadająccych zmianie położenia względem położenia referencyjnego. 
\item Sumowanie przebiegu dla każdego sygnału.
\item Utworzenie funkcji korelacji oraz znalezienie jej maksimum które odpowiada szukanemu przez nas kątowi.
\end{itemize}

\chapter{Specyfikacja projektu}
System składa się z trzech bloków:
\begin{itemize}
\item Blok matrycy czterech mikrofonów.
\item Blok odpowiedzialny za wygenerownie i filrację obwiedni sygnału. 
\item Blok mikrokontrolera.
\end{itemize}
\section{Matryca mikrofonów}
Projekt nie przewidywał budowy matrycy mikrofonów wraz z konstrukcją toru wzmocnienia, dlatego zdecydowano się na zakup gotowego rozwiązania. Na rynku dostępny jest duży wybór czujników mikrofonowych wraz z dedykowanymi układami wzmaczniaczy, dwa z nich zdawały się być najbardziej odpowiednie.\\
Pierwszym z nich jest detektor dźwięku SEN-14262 produkowany przez firmę SparkFun[Rysunek 3.1], posiada on mikrofon elektretowy o zakresie częstotliwości od 100Hz do 10000Hz. Za wzmocnienie sygnału mikrofonowego odpowiada układ LMV324 z możliwością zmiany wzmocnienia od 20dB do 60 dB, podstawowo wartość ta jest usatwiona na 40 dB. Cały moduł posiada aż trzy niezależne wyjścia:
\begin{itemize}
\item Audio - analogowy sygnał audio.
\item Envelope - analogowy sygnał umożliwiający pomiar amplitudy sygnału 
\item Gate - sygnał cyfrowy pozwalający na detekcje przekroczenia ustalonego poziomu amplitudy.
\end{itemize}

\begin{figure}

    \centering

  \includegraphics[width=0.33\textwidth, angle=0]{detektor1.jpg}

    \caption{SparkFun SEN-14262}

    

\end{figure}


 Drugie rozwiązanie to moduł czujnika dźwięku ze wzmaczniaczem MAX9814 produkowany przez firmę Adafruit[Rysunek 3.2], w jego skład wchodzi mikrofon elektretowy umożliwiający pomiary w zakresie 20Hz-20000Hz. Tor wzmacnienia czujnika jest oparty o układ MAX9814, który oferuje takie możliwości jak:
\begin{itemize}
\item AGC(Auto Gain Control) czyli automatycznie zmienne wzmocnienie zależne od poziomu natężenia sygnału wejściowego.
\item Zmienne maksymalne wzmocnienie sygnału 40dB-50dB-60dB. 
\item Ustawienie współczynnika Attack/Release 
\item sygnał wyjściowy na poziomie 2Vpp
\end{itemize}
\newpage
\begin{figure}

    \centering

  \includegraphics[width=0.33\textwidth, angle=0]{detektor2.jpg}

    \caption{Adafruit MAX9814}

    

\end{figure}

Ostatecznie wybrano rozwiązanie zaproponowane przez firmę Adafruit, ze względu na automatyczną kontrolę wzmocnienia, możliwość regulowania współczynnika Attack/Release oraz o wiele korzystaniejszą wartość współczynnika zawartości harmonicznych THD który w układzie MAX9814 dla częstotliwości 1kHz plasuje się na poziomie poniżej 0,1\%, dodatkowo MAX9814 posiada o wiele niższą gęstość szumów.
\section{Generator obwiedni}
Czujnik firmy Adafruit nie posiada wyjścia umożliwiającego pomiar amplitudy dlatego koniecznie jest skonstruowanie zewnętrznego układu odpowiadającego za generowanie obwiedni, rozwiąznie to podyktowane jest chęcią pominięcia złożonych obliczeń na mikrokontrolerze związanych z tranformatą Hilberta. Zastosowano prosty detektor obwiedni.
\begin{figure}

    \centering

  \includegraphics[width=0.6\textwidth, angle=0]{obwiednia.png}

    \caption{Schemat detektora obwiedni}


\end{figure}
\newpage
Dioda umożliwia przepływ prądu tylko jeśli zacisk wejściowy ma potencjał wyższy niż zacisk wyjściowy, kondensator gromadzi ładunek na zboczu narastającym następnie powoli uwalnia go przez rezystor gdy wzgórze opada co w efekcie pozwala uzyskać  filtr górnoprzepustowy. Do zbudowania układu użyto diody 1N914 ze względu na jej dużą szybkość przełączania, wysoką przewodność oraz niezawodność. 
\section{Mikrokontroler i moduł bluetooth}
Kolejnym krokiem przetwarzania sygnału uzyskanego z matrycy mikrofonów jest jego spróbkowanie oraz konwersja do postaci cyfrowej, aby niepotrzebnie nie zwiększać ilości części w układzie elektronicznym zdecydowano się na zastosowanie przetwornika ADC który będzie jednym z peryferiów mikrokontrolera. Przy projektowaniu systemu brano pod uwagę głównie mikrokontrolery firmy STM32 ze względu na:
\begin{itemize}
\item Generator szkieletu projektu CubeMX który przyśpiesza pracę związane z konfiguracją.
\item Wiele darmowych narzędzi oraz przejrzyste IDE SW4.
\item Biblioteke HAL ułatwiajacą pracę z peryferiami.
\item Prostote debuggowania przy pomocy STM studio.
\end{itemize} 
Poszukiwania zawężono do mikrokontrolerów z rodziny F4, ponieważ są one oparte na rdzeniu CortexM4 pozwalającym na szybką pracę z jednostkami zmiennoprzecinkowymi oraz szybkie obliczenia dzięki wysokiemu taktowaniu rdzenia. Finalnie wybór padł na jednostkę STM32F446RET6, jej zalety szczególnie przydatne przy danym projekcie to:
\begin{itemize}
\item Częstotliwość taktowania do 180Mhz.
\item Trzy przetworniki ADC o rozdzielczości 12 bitów.
\item 16 strumieniowy kontroler DMA.
\item 6 interfejsów UART, które pozwolą na jednoczesne monitorowanie każdego z mikrofonów przy przeprowadzaniu testów.
\item 128kB pamięci RAM.
\end{itemize} 
\chapter{Projekt i realizacja modułu
 kierunku przylotu sygnału akustycznego}
 
 \section{Założenia działania modułu}
  Moduł został zaprojektowany tak by mógł składać się z trzech oddzielnych członów opisanych we wcześniejszym rozdziale. Zasade ich wspólnego działania opisuje schemat blokowy(patrz rys. \ref{fig-schematblokowy}).
  \begin{figure}[ht]

    \centering

  \includegraphics[width=0.5\textwidth, angle=0]{diagram.png}

    \caption{Schemat blokowy modułu}
 \label{fig-schematblokowy}
    

\end{figure}

Wzmocniony sygnał audio pochodzący z mikrofonów zostaje podany na wejście mikrokontrolera i detektora obwiedni. Dodatkowo możliwe też jest bezpośrednie podłączenie do układu oscyloskopu, który przyda się podczas fazy testowej modułu. Wyjście detektora obwiedni podłączono do mikrokontrolera, który za pomocą złącza UART wysyła dane do komputera.
Porównanie sygnałów audio otrzymanych przez mikrofony oraz mikrokontroler posłuży do sprawdzenia poprawności działania układu. 
\section{Schemat oraz płytka PCB}
Do zaprojektowania schematu elektronicznego oraz płytki PCB zostało użyte oprogramowanie KiCad.
\subsection{Sekcja zasilania}
Moduł został zasilony napięciem stałym 5V pochodzącym z zewnętrznego zasilacza sieciowego. Jednak z uwagi na to że mikrokontroler oraz systemy  mikrofonowe powinny zostać zasilone napięciem 3,3V, do modułu zaimplementowano stabilizator liniowy LM1117(patrz rys. \ref{fig-stabilizator}).
\begin{figure}[ht]

    \centering

  \includegraphics[width=0.7\textwidth, angle=0]{zasilanie.png}

    \caption{Stabilizator liniowy}
 \label{fig-stabilizator}
    

\end{figure}

W projekcie pominięto zabezpieczenie przed odwrotną polaryzacją źródła zasilania, ponieważ użyta wtyczka zasilacza nie pozwala podłączyć zasilania odwrotnie.

\subsection{Sekcja mikrofonów}
Ze względu na fakt, że mikrofony znajdują się na gotowych komercyjnych PCB , zostaną one przylutowane do płytki głównej poprzez goldpin. Zasilane są one napięciem 3,3V (patrz rys. \ref{fig-mikrofony}).
\begin{figure}[ht]

    \centering

  \includegraphics[width=0.9\textwidth, angle=0]{mikrofony.png}

    \caption{Moduły mikrofonów}
 \label{fig-mikrofony}
    

\end{figure}
\subsection{Sekcja detektora obwiedni}
Detektor obwiedni został zaprojektowany na zasadzie diody oraz rezystora i kondensatora połączonych do niej równolegle (patrz rys. \ref{fig-detektory}).
\begin{figure}[ht]

    \centering

  \includegraphics[width=0.5\textwidth, angle=0]{detektory.png}

    \caption{Schemat detektorów obwiedni}
 \label{fig-detektory}
    

\end{figure}

W tej sekcji zrealizowano również wyprowadzenie używane przy podłączeniu oscyloskopów (patrz rys. \ref{fig-oscyloskop}).
\begin{figure}[ht]

    \centering

  \includegraphics[width=0.15\textwidth, angle=0]{oscyloskop.png}

    \caption{Złącza testowe oscyloskopu}
 \label{fig-oscyloskop}
    

\end{figure}
\newpage

\subsection{Sekcja mikrokontrolera}
Mikrokontroler został zasilony napięciem 3.3V, dotakowo przy jego sekcji zasilania zastosowano filtry tak aby całkowicie wyeliminować wpływ ewentualnych tętnień na jego pracę (patrz rys. \ref{fig-filtry}).
\begin{figure}[ht]

    \centering

  \includegraphics[width=1.1\textwidth, angle=0]{filtry.png}

    \caption{Zasilanie mikrokontrolera}
 \label{fig-filtry}
    

\end{figure}

Kolejną częścią tej sekcji jest podłączenie do przetwornika ADC mikrokontrolera sygnałów otrzymanych z generatora obwiedni oraz mikrofonów (patrz rys. \ref{fig-adc}).
\begin{figure}[ht]

    \centering

  \includegraphics[width=0.6\textwidth, angle=0]{podlaczenie.png}

    \caption{Wejścia ADC}
 \label{fig-adc}
    

\end{figure}

Wyprowadzono także złącze programatora, oprócz jej domyślej funkcji posłóży ono także do wizualizacji danych z mikrofonów za pomocą STM Studio (patrz rys. \ref{fig-programator}).
\begin{figure}[ht]

    \centering

  \includegraphics[width=0.6\textwidth, angle=0]{programator.png}

    \caption{Złącze programatora}
 \label{fig-programator}
    

\end{figure}

% \appendix tworzy dodatek

\addcontentsline{toc}{chapter}{\bibname} %utworzenie w spisie treĹ›ci pozycji Literatura
\bibliography{bibliografia} % wstawia bibliografiÄ™ korzystajÄ…c z pliku bibliografia.bib - dotyczy BibTeXa, jeĹĽeli nie korzystamy z BibTeXa naleĹĽy uĹĽyÄ‡ otoczenia thebibliography

%opcjonalnie moĹĽe siÄ™ tu pojawiÄ‡ spis rysunkĂłw i tabel
% \listoffigures
% \listoftables
\end{document}

